---
import VehicleHeader from '../components/VehicleHeader.jsx';
import { ENDPOINTS } from '../config/api';
import CarStatus from '../components/CarStatus.jsx';
import ControlGrid from '../components/ControlGrid.jsx';
import DigitalTwin from '../components/DigitalTwin.jsx';
import DashboardController from '../components/DashboardController.jsx';
import SystemHealth from '../components/SystemHealth.jsx';
import '../styles/global.css';

// Server-Side Logic
import Layout from '../layouts/Layout.astro';
const token = Astro.cookies.get('access_token')?.value;

if (!token) {
    return Astro.redirect('/login');
}

// Fetch initial vehicle list to get VIN
let vin = '';
try {
    const response = await fetch(ENDPOINTS.VEHICLES, {
        headers: { Cookie: `access_token=${token}` }
    });
    
    if (response.ok) {
        const data = await response.json();
        if (data.data && data.data.length > 0) {
            vin = data.data[0].vinCode;
        }
    }
} catch (e) {
    console.error("Failed to fetch initial vehicle data", e);
}
---

<Layout title="VinFast Dashboard">

        <!-- Dashboard Controller for Polling -->
        <DashboardController client:load vin={vin} />

        <!-- Main Bento Grid Layout -->
		<div class="max-w-7xl mx-auto p-4 space-y-6">
            <header>
                <VehicleHeader client:load />
            </header>

            <main class="grid grid-cols-1 md:grid-cols-12 gap-6 h-auto md:h-[800px]">
                
                {/* Left Column: Battery & Power (Module C) - Span 3 */}
                <div class="md:col-span-3 flex flex-col gap-3 h-auto md:h-full">
                    <CarStatus client:load />
                    
                    {/* Module E: System Health Portal */}
                    <div class="md:flex-1 h-auto">
                        <SystemHealth client:only="react" />
                    </div>
                </div>

                {/* Center Column: Digital Twin (Module B) - Span 6 */}
                <div class="md:col-span-6 relative bg-gray-800/10 rounded-3xl border border-white/5 shadow-2xl backdrop-blur-sm overflow-hidden">
                   <!-- Import Digital Twin here -->
                   <DigitalTwin client:load />
                </div>

                {/* Right Column: Climate & Info (Module D & E) - Span 3 */}
                <div class="md:col-span-3">
                     <ControlGrid client:load />
                </div>

            </main>
        </div>
</Layout>
